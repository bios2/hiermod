{
  "hash": "39eef5766cb2c30e4132ddf8ea275d30",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"'Simple' hierarchical models\"\ntitle-slide-attributes: \n  data-background-image: ../img/bg.jpg\n  data-background-size: full\nauthor: \"Guillaume Blanchet -- Andrew MacDonald\"\ndate: \"2025-05-07\"\nexecute:\n  echo: true\nformat: \n  revealjs:\n    theme: [default]\n    logo: ../img/UdeS_logo_h_rgbHR.png\n    transition: slide\n    background-transition: fade\n---\n\n\n\n## Hierarchical models\n\n. . . \n\nWith a hierarchical model, our interest lies not in finding a single value for a parameter of interest but rather to estimate the ***distribution*** of a parameter of interest and, specifically, the [variance]{style=\"color: blue\"} of this distribution. \n\n. . . \n\nIf we want to estimate the variance of a distribution, we need to gather some samples from this distribution. \n\n. . . \n\nIn the context of a hierarchical model, the \"samples\" are the levels of a factor, which will be used to estimate the variance of the distribution. \n\n\n## \"Simple\" hierarchical model\n\n. . . \n\nHere, we use the term \"simple\" in a rather loose way to discuss hierarchical models where the hierarchy is on **one** parameter without any constrains, whether they are spatial, temporal, phylogenetic or others. \n\n. . . \n\nFuthermore, for most of this lecture, we will focus on models with a Gaussian error term to develop the underlying theory. \n\n. . . \n\nWhen we will have done this, it will be reasonably straight forward to move to non-Gaussian hierarchical model.\n\n\n## The \"`|`\"\n\n. . . \n\n::: {style=\"font-size: 0.8em\"}\nMost of you have probably already used the packages `lme4`, `brms` or `glmmTMB` to build hierarchical models and so you have used the `|` to include a hierarchy in your model.\n:::\n\n. . . \n\n::: {style=\"font-size: 0.8em\"}\nBut do you know what the underlying mathematical structure of the model you built look like ? Does it really answer the question you were asking ?\n:::\n\n![](https://www.i2symbol.com/pictures/emojis/2/1/4/4/21445641aeaca6c4436579b3fa30772b_384.png){fig-align=\"center\" width=20%}\n\n. . .\n\n::: {style=\"font-size: 0.8em\"}\nLet's look at different `lme4` models to learn about some basic (and not so basic!) hierarchical models.\n:::\n\n## A bit of notation\n\n::: {style=\"font-size: 0.8em\"}\nMathematically, the basic structure of a hierarchical model is\n::: \n\n::: {style=\"font-size: 0.8em\"}\n$$\\mathbf{y} = \\mathbf{X} \\boldsymbol{\\beta} + \\mathbf{Z}\\mathbf{b} + \\boldsymbol{\\varepsilon}$$\n::: \n::: {style=\"font-size: 0.8em\"}\nwhere\n::: \n\n::: {style=\"font-size: 0.8em\"}\n- $\\mathbf{y}$ : Vector of response variable\n- $\\mathbf{X}$ : Matrix of explanatory variables on which **no** hierarchies are accounted for\n- $\\mathbf{Z}$ : Matrix of explanatory variables on which hierarchies are accounted for\n- $\\boldsymbol{\\beta}$ : parameter estimated without a hierarchy\n- $\\mathbf{b}$ : parameter estimated with a hierarchy\n- $\\boldsymbol{\\varepsilon}$ : a vector that follows a Gaussian distribution such that ${\\cal N}(0, \\sigma^2)$\n::: \n\n## A bit of notation\n\n. . .\n\n::: {style=\"font-size: 0.9em\"}\nBefore we get into writing math, we need to define a bit of notation in addition of the one we have used so far.\n:::\n\n. . .\n\n::: {style=\"font-size: 0.9em\"}\nSpecifically, when defining a hierarchy in a model, it is common to do this using at least one factor. Mathematically, we will define the different level of a factor in a model by a subscript. \n\nWe will use square brackets to define the sample.\n:::\n\n. . .\n\n**Example**\n\n::: {style=\"font-size: 0.9em\"}\n$$\\mathbf{Z}_{f[i]}$$\nThis means that, within $\\mathbf{Z}$, we focus on the $i^{\\text{th}}$ sample within factor $f$. \n:::\n\n. . .\n\n::: {style=\"font-size: 0.9em\"}\n**Note** The $i^{\\text{th}}$ sample of factor $f$ maybe associated to any level of factor $f$.\n:::\n\n## Hierarchy on the intercept\n\n. . .\n\n::: {style=\"font-size: 0.9em\"}\n`lme4` notation used `y ~ (1 | f)` or `y ~ 1 + (1 | f)`\n:::\n\n. . .\n\n::: {style=\"font-size: 0.9em\"}\nThis model assumes there is a hierarchy solely on the intercept.\n:::\n\n. . .\n\n::: {style=\"font-size: 0.9em\"}\nMathematically, it can be translated to \n\n$$\\mathbf{y} \\sim \\mathcal{MVN}(\\mathbf{b}_{f},\\sigma^2\\mathbf{I})$$\n:::\n\n. . .\n\n::: {style=\"font-size: 0.9em\"}\nor \n\n$$y_i = b_{{f[i]}} + \\varepsilon \\quad \\forall\\quad i = 1\\dots n$$\n:::\n\n. . .\n\n::: {style=\"font-size: 0.9em\"}\nwhere\n\n$$\\mathbf{b}_f \\sim \\mathcal{N}(0, \\sigma^2_f)$$\n:::\n\n## Hierarchy on the intercept\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](index_files/figure-revealjs/unnamed-chunk-1-1.png){fig-align='center' width=768}\n:::\n:::\n\n\n\n## Hierarchy on the slope\n\n::: {style=\"font-size: 0.8em\"}\n`lme4` notation : `y ~ 1 + (x | f)`\n:::\n\n. . .\n\n::: {style=\"font-size: 0.8em\"}\nThis model assumes there is a hierarchy on the parameter associated to variable `x`.\n:::\n\n. . .\n\n::: {style=\"font-size: 0.8em\"}\nMathematically, it can be translated to \n\n$$\\mathbf{y} \\sim \\mathcal{MVN}(\\beta_0 + \\mathbf{z}\\mathbf{b}_{f},\\sigma^2\\mathbf{I})$$\n:::\n\n. . .\n\n::: {style=\"font-size: 0.8em\"}\nor \n\n$$y_i = \\beta_0 + b_{f[i]}z_i + \\varepsilon \\quad\\forall\\quad i = 1\\dots n$$\n:::\n\n. . .\n\n::: {style=\"font-size: 0.8em\"}\nwhere \n\n$\\mathbf{z}$ is an explanatory variable, $z_i$ the $i^{\\text{th}}$ sample of $\\mathbf{z}$ and \n\n$$\\mathbf{b}_f \\sim \\mathcal{N}(0, \\sigma^2_f)$$\n:::\n\n## Hierarchy on the slopes\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](index_files/figure-revealjs/unnamed-chunk-2-1.png){fig-align='center' width=768}\n:::\n:::\n\n\n\n## Hierarchy on intercept and slope\n\n. . .\n\nMathematically speaking, what are the differences between having a hierarchy on the intercept and a hierarchy on the slope ? Any idea ?\n\n![](https://www.i2symbol.com/pictures/emojis/4/c/e/b/4ceb092d154efb14f6913cb5e332f6da_384.png){fig-align=\"center\" width=50%}\n\n## Hierarchy on intercept and slope\n\n**Answer : Very little !**\n\n. . .\n\nActually, if we return to the way $\\mathbf{b}$ is defined we see that in both case it is defined as \n\n$$\\mathbf{b}_f \\sim \\mathcal{N}(0, \\sigma^2_f)$$\nwith the sole difference is that $\\mathbf{b}$ is linked to an explanatory variable when the hierarchy is on the slope, while when the hierarchy is on the intercept it is not linked to any explanatory variable.\n\n. . .\n\nWell... Actually... When a hierarchy is applied on the intercept it is technically associated to a **constant** explanatory variable.\n\n## How many levels ?\n\n. . .\n\nA common question that often gets asked is : \n\n. . .\n\n\"How many level is enough ?\"\n\n. . .\n\nThis is a simple questions that sadly does not have a simple answer.\n\n![](https://www.i2symbol.com/pictures/emojis/7/e/1/8/7e1820e72993db112424b5a92e1d40d7_384.png){fig-align=\"center\" width=35%}\n\n## How many levels ?\n\nIn these types of models we are interested in estimating the variance parameter $\\sigma^2_f$ in \n\n$$\\mathbf{b}_f \\sim \\mathcal{N}(0, \\sigma^2_f)$$\nto get the best estimation of $\\mathbf{b}$. \n\n. . .\n\nSo, another way to ask this question is: \"What is the minimum number of samples needed to properly estimate the variance of a Gaussian distribution?\" \n\n. . .\n\nHowever, in the context of how we defined hierarchical models, a sample is a single level of a factor.\n\n## How many levels ?\n\nWhat is the minimum number of samples needed to properly estimate the variance of a Gaussian distribution?\n\n. . .\n\n### Is 3 enough ?\n:::: {.columns}\n::: {.column width=\"50%\"}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](index_files/figure-revealjs/unnamed-chunk-3-1.png){fig-align='center' width=768}\n:::\n:::\n\n\n:::\n::: {.column width=\"50%\"}\nTrue variance : 0.25\n\nEstimated variance : 0.234\n:::\n::::\n\n\n## How many levels ?\n\nWhat is the minimum number of samples needed to properly estimate the variance of a Gaussian distribution?\n\n### Maybe 5 ?\n:::: {.columns}\n::: {.column width=\"50%\"}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](index_files/figure-revealjs/unnamed-chunk-4-1.png){fig-align='center' width=768}\n:::\n:::\n\n\n:::\n::: {.column width=\"50%\"}\nTrue variance : 0.25\n\nEstimated variance : 0.12\n:::\n::::\n\n## How many levels ?\n\nWhat is the minimum number of samples needed to properly estimate the variance of a Gaussian distribution?\n\n### Or 10 ?\n:::: {.columns}\n::: {.column width=\"50%\"}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](index_files/figure-revealjs/unnamed-chunk-5-1.png){fig-align='center' width=768}\n:::\n:::\n\n\n:::\n::: {.column width=\"50%\"}\nTrue variance : 0.25\n\nEstimated variance : 0.174\n:::\n::::\n\n\n## How many levels ?\n\nWhat is the minimum number of samples needed to properly estimate the variance of a Gaussian distribution?\n\n### Or 50 ?\n:::: {.columns}\n::: {.column width=\"50%\"}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](index_files/figure-revealjs/unnamed-chunk-6-1.png){fig-align='center' width=768}\n:::\n:::\n\n\n:::\n::: {.column width=\"50%\"}\nTrue variance : 0.25\n\nEstimated variance : 0.331\n:::\n::::\n\n\n## How many levels ?\n\nWhat is the minimum number of samples needed to properly estimate the variance of a Gaussian distribution?\n\n### Or 100 ?\n:::: {.columns}\n::: {.column width=\"50%\"}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](index_files/figure-revealjs/unnamed-chunk-7-1.png){fig-align='center' width=768}\n:::\n:::\n\n\n:::\n::: {.column width=\"50%\"}\nTrue variance : 0.25\n\nEstimated variance : 0.271\n:::\n::::\n\n\n## How many levels ?\n\nWhat is the minimum number of samples needed to properly estimate the variance of a Gaussian distribution?\n\n### Or 1000 ?\n:::: {.columns}\n::: {.column width=\"50%\"}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](index_files/figure-revealjs/unnamed-chunk-8-1.png){fig-align='center' width=768}\n:::\n:::\n\n\n:::\n::: {.column width=\"50%\"}\nTrue variance : 0.25\n\nEstimated variance : 0.251\n:::\n::::\n\n## How many levels ?\n\nThere is a consensus among researchers working intimately with hierarchical models that when the interest is to properly estimate the variance parameter $\\sigma^2$, 5 or 6 levels is the extreme minimum.\n\n. . .\n\n::: {style=\"font-size: 0.75em\"}\nIn the book *Richly Parameterized Linear Models: Additive, Time Series, and Spatial Models Using Random Effects*, James S. Hodges (2016) makes this very thoughtful statement : \n\n:::: {style=\"color: blue\"}\n\"Treating factors with small numbers of levels as random will in the best case lead to very small and/or imprecise estimates of random effects; in the worst case it will lead to various numerical difficulties such as lack of convergence, zero variance estimates, etc.\"\n::::\n:::\n\n## How many levels ?\n\nSo, what to do if the number of level is not high enough for your comfort ?\n\n. . .\n\nYou can still use the hierarchy in your model but focus on the mean of the levels instead of the variance.\n\n. . .\n\nHow does this translate mathematically with what we have seen so far ?\n\n![](https://www.i2symbol.com/pictures/emojis/4/c/e/b/4ceb092d154efb14f6913cb5e332f6da_384.png){fig-align=\"center\" width=30%}\n\n## Hierarchy on the intercept's mean\n\n::: {style=\"font-size: 0.85em\"}\n$$\\mathbf{y} \\sim \\mathcal{MVN}(\\boldsymbol{\\beta}_{f},\\sigma_\\mathbf{y}^2\\mathbf{I})$$\nor \n\n$$y_i = \\beta_{f[i]} + \\varepsilon \\quad \\forall\\quad i = 1\\dots n$$\n:::\n\n. . .\n\n::: {style=\"font-size: 0.85em\"}\nIn this model, we assume that $\\boldsymbol{\\beta}_{f}$ is distributed as \n\n$$\\boldsymbol{\\beta}_{f} \\sim \\mathcal{N}(\\mu_{f}, \\sigma^2_{f})$$\n:::\n\n. . .\n\n::: {style=\"font-size: 0.85em\"}\nThis means that all samples **among** the levels of factor $f$ are used to estimate $\\boldsymbol{\\beta}_{f}$. \n:::\n\n. . .\n\n::: {style=\"font-size: 0.85em\"}\nBy developping our model this way, we focus on estimating the mean of groups in the hierarchy instead of only the variance. \n:::\n\n## Hierarchy on the intercept's mean\n\nLet's take a deeper look at \n$$\\boldsymbol{\\beta}_{f} \\sim \\mathcal{N}(\\mu_{f}, \\sigma^2_{f})$$\n\n. . .\n\nWhen we study this way of sampling $\\boldsymbol{\\beta}_{f}$, although our interest is more on $\\mu_{f}$, we also have to acount for the variance term $\\sigma^2_{f}$.\n\n. . .\n\n**Note**: This is essentially the same thing as a one-way analysis of variance.\n\n## Hierarchy on the intercept's mean\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](index_files/figure-revealjs/unnamed-chunk-9-1.png){fig-align='center' width=768}\n:::\n:::\n\n\n\n## Hierarchy on the slope's mean\n\n. . .\n\n::: {style=\"font-size: 0.75em\"}\nDevelopping a hierarchy on the slope's mean translate mathematically in a very similar way as it does for the intercept. \n:::\n\n. . .\n\n::: {style=\"font-size: 0.75em\"}\n$$\\mathbf{y} \\sim \\mathcal{MVN}(\\boldsymbol{\\beta}_0+\\mathbf{X}\\boldsymbol{\\beta}_{f},\\sigma_\\mathbf{y}^2\\mathbf{I})$$\nor \n\n$$y_i = \\beta_0 + \\beta_{f[i]}x_i + \\varepsilon \\quad \\forall\\quad i = 1\\dots n$$\n:::\n\n. . .\n\n::: {style=\"font-size: 0.75em\"}\nIn this model, we assume that $\\boldsymbol{\\beta}_{f}$ is distributed as \n\n$$\\boldsymbol{\\beta}_{f} \\sim \\mathcal{N}(\\mu_{f}, \\sigma^2_{f})$$\n:::\n\n. . .\n\n::: {style=\"font-size: 0.75em\"}\nThis means that all the samples **among** the levels of factor $f$ are used to estimate $\\boldsymbol{\\beta}_{f}$\n\nBy developping our model this way, we focus on estimating the average slope for each group in the hierarchy instead of only the variance. \n:::\n\n## Hierarchy on the slope's mean\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](index_files/figure-revealjs/unnamed-chunk-10-1.png){fig-align='center' width=768}\n:::\n:::\n\n\n\n## Tracking the estimated parameters\n\n. . .\n\n::: {style=\"font-size: 0.8em;\"}\nAs can be seen, it is important in hierarchical models to track the different parameters that are estimated to ensure we can make proper inferences with our model.\n:::\n\n. . .\n\n::: {style=\"font-size: 0.8em;\"}\nHowever, we need to be careful because the notation used can play tricks on us. This is especially true when using matrix notation. \n:::\n\n. . .\n\n::: {style=\"font-size: 0.8em;\"}\nFor example, in \n\n$$\\mathbf{b}_{f}\\sim \\mathcal{MVN}(\\mathbf{0}, \\mathbf{\\Sigma})$$\nthe number of levels are not explicitly defined and it is not clear if $\\mathbf{\\Sigma}$ includes the same variance value on the diagonal or different ones and whether the off diagonal elements are 0 or not. \n:::\n\n. . .\n\n::: {style=\"font-size: 0.8em;\"}\nIn any case, make sure to keep track of the estimated parameters so that you can better understand the limits of the model you are building and using. \n:::\n\n## Choosing the right model\n\n. . . \n\nAlthough these different models are mathematically quite similar, they approach very different biological questions. \n\n. . . \n\nA comparison of the different figures caricaturizing how each model works should give a good insight of what each model can do.\n\n. . . \n\nIt is thus important to make sure you design your biological question well so that deciding on which model to use is reasonably straight forward.\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}